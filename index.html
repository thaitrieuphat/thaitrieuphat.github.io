<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thi·ªáp ƒëi·ªán t·ª≠ 20/11 - L·ªõp 10C1 THPT Ho√† L·∫°c</title>
  <style>
    :root{
      --card-w: 760px;
      --card-h: 480px;
      --accent: #f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      /* School background image with subtle overlay for readability */
      background-image:linear-gradient(rgba(255,248,231,0.65), rgba(255,227,179,0.55)), url('https://images.unsplash.com/photo-1509062522246-3755977927d7?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=8b9b9f6b8f8f2a4b3e6b3c2d1a0e9f6a');
      background-size:cover;
      background-position:center center;
      font-family: 'Segoe UI', system-ui, sans-serif;
      overflow:auto;
      padding:30px;
    }

    /* Book container */
    .book-wrap{
      width:100%;
      max-width:var(--card-w);
      height:var(--card-h);
      perspective:2200px;
      position:relative;
    }

    .book{
      width:100%;
      height:100%;
      position:relative;
      transform-style:preserve-3d;
    }

    /* Each page: front + back */
    .page{
      position:absolute;
      inset:0;
      transform-origin:left center;
      transition:transform 800ms cubic-bezier(.2,.8,.2,1), box-shadow 400ms;
      transform-style:preserve-3d;
      border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .page .side{
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      padding:28px;
      overflow-y:auto;
    }

    .page .side img{
      max-width:95%;
      max-height:220px;
      border-radius:8px;
      object-fit:cover;
      margin:8px 0;
    }

    .page .front{
      background:linear-gradient(0deg, rgba(255,255,255,.85), rgba(255,255,255,.7));
    }

    .page .back{
      transform:rotateY(180deg);
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
    }

    /* stacked pages: earlier pages on top */
    .page[data-index="1"]{z-index:4}
    .page[data-index="2"]{z-index:3}
    .page[data-index="3"]{z-index:2}
    .page[data-index="4"]{z-index:1}

    /* when flipped */
    .page.flipped{
      transform: rotateY(-180deg);
      box-shadow: -8px 8px 30px rgba(0,0,0,.12);
    }

    /* content */
    h1{font-size:1.6rem;margin:0 0 8px;color:#b91c1c}
    p{font-size:1rem;margin:0;color:#333;line-height:1.4;text-align:center}

    .controls{
      margin-top:auto;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;
      padding-top:12px;
    }

    button.btn{
      background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;
    }
    button.btn:disabled{opacity:.6;cursor:not-allowed}

    /* small UI: music toggle + prev/next */
    .ui-top{position:absolute;right:14px;top:14px;display:flex;gap:8px;z-index:60}
    .ui-top button{background:#22c55e;padding:8px 10px;border-radius:8px;border:none;color:#fff;cursor:pointer}

    /* flower animation */
    .flower{position:fixed;top:-60px;font-size:20px;pointer-events:none;animation:fall linear;}
    @keyframes fall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

    /* responsive - tablet & mobile */
    @media (max-width:1024px){
      :root{--card-w:85vw;--card-h:60vh}
      h1{font-size:1.5rem}
      p{font-size:0.95rem}
      .page .side{padding:20px}
      .page .side img{max-height:200px}
    }

    @media (max-width:768px){
      :root{--card-w:90vw;--card-h:55vh}
      h1{font-size:1.3rem}
      p{font-size:0.9rem}
      .page .side{padding:16px}
      .page .side img{max-height:170px}
      body{padding:15px}
    }

    @media (max-width:600px){
      :root{--card-w:95vw;--card-h:50vh}
      h1{font-size:1.1rem}
      p{font-size:0.85rem}
      .page .side{padding:12px}
      .page .side img{max-height:150px}
      .controls{margin-top:8px;flex-wrap:wrap}
      button.btn{padding:6px 10px;font-size:0.9rem}
      .ui-top{right:8px;top:8px;gap:4px}
      .ui-top button{padding:6px 8px;font-size:0.8rem}
      #volumeSlider{width:100px !important}
      body{padding:10px}
      .flower{font-size:16px}
    }

    @media (max-width:400px){
      :root{--card-w:98vw;--card-h:45vh}
      h1{font-size:1rem}
      p{font-size:0.8rem;line-height:1.3}
      .page .side{padding:10px}
      .page .side img{max-height:130px}
      .controls{margin-top:6px;gap:4px}
      button.btn{padding:5px 8px;font-size:0.85rem}
      .ui-top{right:6px;top:6px}
      #volumeSlider{width:80px !important}
      .flower{font-size:14px}
    }
  </style>
</head>
<body>

  <div class="book-wrap" id="bookWrap">
    <div class="ui-top">
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
        <button id="musicToggle">üîä Nh·∫°c: T·∫Øt</button>
        <input id="volumeSlider" type="range" min="0" max="100" value="60" style="display:none;width:140px;" aria-label="Volume" />
      </div>
    </div>
    <!-- Background audio (MP3). Put your file next to this HTML or use a full URL -->
    <audio id="bgAudio" src="nh·∫°c 20-11.mp3" loop preload="auto" autoplay muted></audio>
    <!-- Autoplay notice shown if browser blocks autoplay -->
    <div id="autoplayNotice" style="position:absolute;left:50%;top:8px;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:6px;font-size:0.9rem;display:none;z-index:80">Nh·∫•n v√†o trang ho·∫∑c nh·∫•n n√∫t nh·∫°c ƒë·ªÉ b·∫≠t √¢m thanh</div>

    <div class="book" id="book">
      <!-- Page 1 -->
      <div class="page" data-index="1">
        <div class="side front">
          <img src="page1.jpg" style="max-width:100%;max-height:120px;margin-bottom:12px;border-radius:8px;object-fit:cover;">
          <h1>Ch√∫c m·ª´ng ng√†y Nh√† gi√°o Vi·ªát Nam 20/11</h1>
          <p>H√¥m nay l√† d·ªãp ƒë·ªÉ ch√∫ng em d·ª´ng l·∫°i, nghƒ© v·ªÅ h√†nh tr√¨nh h·ªçc t·∫≠p v√† nh·ªØng ng∆∞·ªùi ƒë√£ d√¨u d·∫Øt. Xin g·ª≠i l·ªùi c·∫£m ∆°n s√¢u s·∫Øc ƒë·∫øn c√°c th·∫ßy c√¥ ƒë√£ d√†nh bao t√¢m huy·∫øt, ki√™n nh·∫´n v√† t√¨nh th∆∞∆°ng ƒë·ªÉ trao ki·∫øn th·ª©c v√† ch·ªâ d·∫´n cho ch√∫ng em t·ª´ng b∆∞·ªõc tr∆∞·ªüng th√†nh.</p>
          <p>M·ªói b√†i gi·∫£ng, m·ªói l·ªùi khuy√™n ƒë√£ vun ƒë·∫Øp n√™n k√Ω ·ª©c v√† k·ªπ nƒÉng gi√∫p ch√∫ng em t·ª± tin h∆°n tr√™n ƒë∆∞·ªùng ƒë·ªùi. Ch√∫c th·∫ßy c√¥ lu√¥n m·∫°nh kh·ªèe, gi·ªØ v·ªØng nhi·ªát huy·∫øt v√† m√£i l√† ng·ªçn ƒë√®n soi ƒë∆∞·ªùng cho nhi·ªÅu th·∫ø h·ªá h·ªçc tr√≤.</p>
          <div class="controls"><button class="btn" onclick="next()">L·∫≠t ti·∫øp ‚û§</button></div>
        </div>
        <div class="side back">
          <h1>Nh·ªõ m√£i ∆°n th·∫ßy c√¥</h1>
          <img src="page1.jpg" style="max-width:100%;max-height:120px;margin:12px 0;border-radius:8px;object-fit:cover;">
          <p>Trong t·ª´ng b∆∞·ªõc ƒëi c·ªßa cu·ªôc ƒë·ªùi, ch√∫ng em v·∫´n nh·ªõ nh·ªØng bu·ªïi s√°ng ƒë·∫øn l·ªõp, nh·ªØng b√†i gi·∫£ng t·∫≠n t√¢m v√† c·∫£ nh·ªØng l·ªùi ƒë·ªông vi√™n khi th·∫•t b·∫°i. ·∫§m √°p v√† s√¢u s·∫Øc, c√¥ng ∆°n ·∫•y lu√¥n ·ªü l·∫°i trong tim.</p>
          <p>Ch√∫ng em nguy·ªán mang nh·ªØng b√†i h·ªçc ·∫•y, truy·ªÅn l·∫°i ni·ªÅm y√™u th∆∞∆°ng v√† s·ª± t√¥n tr·ªçng, ƒë·ªÉ m·ªói h√†nh ƒë·ªông ƒë·ªÅu l√† l·ªùi tri √¢n d√†nh cho th·∫ßy c√¥.</p>
        </div>
      </div>

      <!-- Page 2 -->
      <div class="page" data-index="2">
        <div class="side front">
          <img src="page2.jpg" style="max-width:100%;max-height:120px;margin-bottom:12px;border-radius:8px;object-fit:cover;">
          <h1>C√¥ng ∆°n c√¥ th·∫ßy</h1>
          <p>Th·∫ßy c√¥ kh√¥ng ch·ªâ truy·ªÅn d·∫°y ki·∫øn th·ª©c m√† c√≤n d·∫°y ch√∫ng em c√°ch suy nghƒ©, c√°ch ƒë·ªëi di·ªán v·ªõi th·ª≠ th√°ch v√† c√°ch s·ªëng c√≥ tr√°ch nhi·ªám. M·ªói b√†i h·ªçc l√† m·ªôt vi√™n g·∫°ch x√¢y n·ªÅn t·∫£ng cho t∆∞∆°ng lai.</p>
          <p>Nh·ªØng l·ªùi khuy√™n gi·∫£n d·ªã, nh·ªØng t·∫•m g∆∞∆°ng ki√™n tr√¨, nh·ªØng gi·ªù gi·∫£ng t·∫≠n t√¢m ƒë√£ gi√∫p ch√∫ng em v∆∞·ª£t qua nh·ªØng b·ª° ng·ª° ban ƒë·∫ßu ƒë·ªÉ v·ªØng b∆∞·ªõc tr√™n con ƒë∆∞·ªùng h·ªçc v·∫•n v√† cu·ªôc s·ªëng.</p>
          <div class="controls"><button class="btn" onclick="prev()">‚óÄ Quay l·∫°i</button><button class="btn" onclick="next()">L·∫≠t ti·∫øp ‚û§</button></div>
        </div>
        <div class="side back">
          <h1>Nh·ªõ m√£i trong tim</h1>
          <img src="page2.jpg" style="max-width:100%;max-height:120px;margin:12px 0;border-radius:8px;object-fit:cover;">
          <p>D√π mai n√†y m·ªói ng∆∞·ªùi m·ªôt n∆°i, nh∆∞ng k√Ω ·ª©c v·ªÅ l·ªõp h·ªçc, v·ªÅ √°nh m·∫Øt v√† n·ª• c∆∞·ªùi c·ªßa th·∫ßy c√¥ v·∫´n lu√¥n ·∫•m √°p. Ch√∫ng em mang theo s·ª± bi·∫øt ∆°n ƒë√≥ trong m·ªçi h√†nh ƒë·ªông v√† l·ª±a ch·ªçn.</p>
          <p>Xin ch√∫c th·∫ßy c√¥ lu√¥n c√≥ ni·ªÅm vui trong c√¥ng vi·ªác, nh·∫≠n l·∫°i nhi·ªÅu y√™u th∆∞∆°ng v√† tr√¢n tr·ªçng t·ª´ h·ªçc tr√≤ v√† ƒë·ªìng nghi·ªáp.</p>
        </div>
      </div>

      <!-- Page 3 -->
      <div class="page" data-index="3">
        <div class="side front">
          <img src="page3.jpg" style="max-width:100%;max-height:120px;margin-bottom:12px;border-radius:8px;object-fit:cover;">
          <h1>L·ªùi tri √¢n</h1>
          <p>Nh√¢n ng√†y 20/11, em xin g·ª≠i t·ªõi th·∫ßy c√¥ l·ªùi tri √¢n s√¢u s·∫Øc nh·∫•t ‚Äî v√¨ nh·ªØng ƒë√™m khuya so·∫°n b√†i, v√¨ nh·ªØng l·∫ßn ki√™n nh·∫´n gi·∫£i th√≠ch khi ch√∫ng em c√≤n m∆° h·ªì, v√¨ ni·ªÅm tin th·∫ßy c√¥ ƒë·∫∑t v√†o t·ª´ng h·ªçc tr√≤.</p>
          <p>Em mong r·∫±ng nh·ªØng n·ªó l·ª±c v√† t·∫≠n t√¢m c·ªßa th·∫ßy c√¥ s·∫Ω lu√¥n ƒë∆∞·ª£c ghi nh·∫≠n, v√† r·∫±ng m·ªói ng√†y ƒë·∫øn l·ªõp l√† m·ªôt ni·ªÅm vui, m·ªôt ngu·ªìn c·∫£m h·ª©ng ƒë·ªÉ ti·∫øp t·ª•c gieo tri th·ª©c.</p>
          <div class="controls"><button class="btn" onclick="prev()">‚óÄ Quay l·∫°i</button><button class="btn" onclick="next()">L·∫≠t ti·∫øp ‚û§</button></div>
        </div>
        <div class="side back">
          <h1>C·∫£m ∆°n th·∫ßy c√¥</h1>
          <img src="page3.jpg" style="max-width:100%;max-height:120px;margin:12px 0;border-radius:8px;object-fit:cover;">
          <p>M·ªói k·ª∑ ni·ªám, m·ªói b√†i h·ªçc ƒë·ªÅu tr·ªü th√†nh h√†nh trang qu√Ω b√°u. Ch√∫ng em bi·∫øt ∆°n nh·ªØng gi√¢y ph√∫t th·∫ßy c√¥ ƒë√£ d√†nh ƒë·ªÉ l·∫Øng nghe, h∆∞·ªõng d·∫´n v√† d√¨u d·∫Øt.</p>
          <p>Xin c·∫ßu ch√∫c th·∫ßy c√¥ lu√¥n an l√†nh, h·∫°nh ph√∫c v√† ti·∫øp t·ª•c lan t·ªèa s·ª± t·ª≠ t·∫ø cho nh·ªØng th·∫ø h·ªá sau.</p>
        </div>
      </div>

      <!-- Page 4 -->
      <div class="page" data-index="4">
        <div class="side front">
          <img src="page4.jpg" style="max-width:100%;max-height:120px;margin-bottom:12px;border-radius:8px;object-fit:cover;">
          <h1>K·∫øt th√∫c</h1>
          <p>Ch√∫ng em - t·∫≠p th·ªÉ l·ªõp 10C1, xin k√≠nh ch√∫c c√¥ th·∫ßy s·ª©c kh·ªèe, ni·ªÅm vui v√† nh·ªØng ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t trong cu·ªôc s·ªëng. L·ªùi ch√∫c n√†y mang theo t·∫•t c·∫£ l√≤ng bi·∫øt ∆°n v√† tr√¢n tr·ªçng c·ªßa ch√∫ng em d√†nh cho nh·ªØng ng∆∞·ªùi ƒë√£ d√¨u d·∫Øt.</p>
          <p>Hy v·ªçng r·∫±ng nh·ªØng gieo tr·ªìng y√™u th∆∞∆°ng v√† ki·∫øn th·ª©c c·ªßa th·∫ßy c√¥ s·∫Ω ti·∫øp t·ª•c n·∫£y m·∫ßm v√† ƒëem l·∫°i hoa tr√°i cho nhi·ªÅu th·∫ø h·ªá mai sau.</p>
          <div class="controls"><button class="btn" onclick="prev()">‚óÄ Quay l·∫°i</button></div>
        </div>
        <div class="side back">
          <h1>‚Äî K√≠nh g·ª≠i ‚Äî</h1>
          <img src="page4.jpg" style="max-width:100%;max-height:120px;margin:12px 0;border-radius:8px;object-fit:cover;">
          <p>V·ªõi t·∫•t c·∫£ l√≤ng bi·∫øt ∆°n v√† y√™u th∆∞∆°ng, ch√∫ng em - t·∫≠p th·ªÉ l·ªõp 10C1 - xin ch√∫c th·∫ßy c√¥ lu√¥n an y√™n v√† m√£i l√† ng·ªçn l·ª≠a d·∫´n ƒë∆∞·ªùng.</p>
          <p>Tr√¢n tr·ªçng g·ª≠i t·ªõi th·∫ßy c√¥ nh·ªØng l·ªùi ch√∫c ·∫•m √°p nh·∫•t t·ª´ h·ªçc tr√≤ c·ªßa m√¨nh.</p>
        </div>
      </div>
    </div>
    
    <div style="position:absolute;left:14px;bottom:14px;z-index:60;display:flex;gap:8px;">
      <!-- N√∫t ƒëi·ªÅu khi·ªÉn ƒë∆∞·ª£c lo·∫°i b·ªè - ch·ªâ s·ª≠ d·ª•ng n√∫t L·∫≠t ti·∫øp/Quay l·∫°i trong trang -->
    </div>
  </div>

  <script>
    // Pages stack and flipping logic
    const pages = Array.from(document.querySelectorAll('.page'));
    let current = 0; // how many pages flipped

    function updateButtons(){
      document.getElementById('btnPrev').disabled = current === 0;
      document.getElementById('btnNext').disabled = current === pages.length;
    }

    function next(){
      if(current >= pages.length) return;
      // flip the top-most unflipped page
      const page = pages[current];
      page.classList.add('flipped');
      current++;
      updateButtons();
    }

    function prev(){
      if(current <= 0) return;
      // unflip the last flipped page
      const page = pages[current-1];
      page.classList.remove('flipped');
      current--;
      updateButtons();
    }

    // Clicking on a page also flips it (for convenience)
    pages.forEach((p, i)=>{
      p.addEventListener('click', (e)=>{
        // avoid flipping when clicking control buttons inside
        if(e.target.tagName.toLowerCase() === 'button') return;
        if(i >= current) next(); else prev();
      });
    });

    updateButtons();

    /* ========== OPTIMIZED FLOWERS (POOLING) ========== */
    const flowerEmojis = ['üå∏','üåº','üíÆ','üå∑','üåª'];
    const MAX_FLOWERS = 12;
    const flowerPool = [];
    function initFlowerPool(){
      for(let i=0;i<MAX_FLOWERS;i++){
        const el = document.createElement('div');
        el.className = 'flower';
        el.style.display = 'none';
        el.style.willChange = 'transform,opacity';
        el.addEventListener('animationend', ()=>{ el.style.display='none'; });
        document.body.appendChild(el);
        flowerPool.push(el);
      }
    }
    initFlowerPool();

    function createFlower(){
      const free = flowerPool.find(x=>x.style.display==='none');
      if(!free) return; // pool exhausted
      free.style.display = 'block';
      free.textContent = flowerEmojis[Math.floor(Math.random()*flowerEmojis.length)];
      free.style.left = Math.random()*90 + 'vw';
      free.style.fontSize = (12 + Math.random()*22) + 'px';
      free.style.animationDuration = (4 + Math.random()*4) + 's';
      free.style.opacity = '1';
    }
    const flowerInterval = setInterval(createFlower, 900);

    /* ========== PAGE-FLIP SOUND (WebAudio) ========== */
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    function ensureAudioCtx(){
      if(!audioCtx) audioCtx = new AudioCtx();
    }

    // Short filtered noise burst to simulate page flip
    function playFlipSound(){
      try{
        ensureAudioCtx();
        const len = 0.06; // seconds
        const bufferSize = Math.floor(audioCtx.sampleRate * len);
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 1000 + Math.random()*2000;
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.06, audioCtx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06);
        src.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
        src.start();
        src.stop(audioCtx.currentTime + len);
      }catch(e){console.warn('Audio error',e)}
    }

    /* ========== Background MP3 audio (HTML5) ========== */
    const bgAudio = document.getElementById('bgAudio');
    const musicBtn = document.getElementById('musicToggle');
    const volSlider = document.getElementById('volumeSlider');
    let musicOn = false;
    const VOLUME_KEY = 'gift-music-volume';

    // Load saved volume from localStorage on page load
    function loadSavedVolume(){
      const saved = localStorage.getItem(VOLUME_KEY);
      if(saved !== null){
        const vol = Math.max(0, Math.min(100, parseInt(saved, 10)));
        if(volSlider) volSlider.value = vol;
        if(bgAudio) bgAudio.volume = vol/100;
      }
    }

    // Save volume to localStorage
    function saveVolume(val){
      try{ localStorage.setItem(VOLUME_KEY, val); }catch(e){}
    }

    loadSavedVolume();

    const AUDIO_STATE_KEY = 'gift-audio-state';

    // Save audio state to localStorage
    function saveAudioState(){
      try{
        if(bgAudio){
          const state = {
            wasPlaying: musicOn && !bgAudio.paused,
            currentTime: bgAudio.currentTime || 0,
            muted: bgAudio.muted,
            volume: bgAudio.volume
          };
          localStorage.setItem(AUDIO_STATE_KEY, JSON.stringify(state));
          console.log('[audio] state saved:', state);
        }
      }catch(e){ console.warn('[audio] save state error', e); }
    }

    // Restore audio state from localStorage
    function restoreAudioState(){
      try{
        const saved = localStorage.getItem(AUDIO_STATE_KEY);
        if(saved){
          const state = JSON.parse(saved);
          console.log('[audio] state restored:', state);
          return state;
        }
      }catch(e){ console.warn('[audio] restore state error', e); }
      return null;
    }

    // Try to resume audio from saved state
    function tryResumeFromState(state){
      if(!state || !state.wasPlaying || !bgAudio) return;
      try{
        bgAudio.muted = state.muted;
        bgAudio.volume = state.volume;
        if(state.currentTime > 0){
          try{ bgAudio.currentTime = state.currentTime; }catch(e){}
        }
        const p = bgAudio.play();
        if(p && typeof p.then === 'function'){
          p.then(()=>{
            musicOn = true;
            if(musicBtn) musicBtn.textContent = state.muted ? 'üîä Nh·∫°c: B·∫≠t (t·∫Øt ti·∫øng)' : 'üîä Nh·∫°c: B·∫≠t';
            if(volSlider) volSlider.style.display = 'block';
            console.log('[audio] resumed from saved state');
          }).catch((err)=>{
            console.warn('[audio] resume blocked:', err.message);
          });
        } else {
          musicOn = true;
          if(musicBtn) musicBtn.textContent = state.muted ? 'üîä Nh·∫°c: B·∫≠t (t·∫Øt ti·∫øng)' : 'üîä Nh·∫°c: B·∫≠t';
          if(volSlider) volSlider.style.display = 'block';
        }
      }catch(e){ console.warn('[audio] tryResumeFromState error', e); }
    }

    // Try muted autoplay first (browsers often allow muted autoplay)
    function tryAutoPlayAudio(){
      if(!bgAudio) return;
      try{
        bgAudio.muted = true;
        // initialize volume from slider
        if(volSlider) bgAudio.volume = volSlider.value/100;
        const playPromise = bgAudio.play();
        if(playPromise !== undefined){
          playPromise.then(()=>{
            // playing (muted) succeeded
            musicOn = true;
            if(musicBtn) musicBtn.textContent = 'üîä Nh·∫°c: B·∫≠t (t·∫Øt ti·∫øng)';
            // show volume slider so user can unmute if desired
            if(volSlider) volSlider.style.display = 'block';
            // show notice prompting user to unmute for full audio
            document.getElementById('autoplayNotice').style.display = 'block';
          }).catch(()=>{
            // autoplay blocked; show notice
            document.getElementById('autoplayNotice').style.display = 'block';
          });
        }
      }catch(e){
        document.getElementById('autoplayNotice').style.display = 'block';
      }
    }

    // On page load: try autoplay, then restore and try resume from saved state
    tryAutoPlayAudio();
    if(bgAudio && !bgAudio.paused){
      musicOn = true;
      if(musicBtn) musicBtn.textContent = 'üîä Nh·∫°c: B·∫≠t (t·∫Øt ti·∫øng)';
      if(volSlider) volSlider.style.display = 'block';
    }

    // Try resume from saved state on load
    const savedState = restoreAudioState();
    if(savedState && savedState.wasPlaying){
      console.log('[audio] saved state found - will try resume on first interaction');
    }

    // Music button toggles play/pause and unmutes when turning on
    musicBtn.addEventListener('click', ()=>{
      ensureAudioCtx();
      if(!bgAudio) return;
      if(!musicOn){
        // unmute and play at slider volume
        bgAudio.muted = false;
        if(volSlider) bgAudio.volume = volSlider.value/100;
        bgAudio.play().then(()=>{
          musicOn = true;
          musicBtn.textContent = 'üîä Nh·∫°c: B·∫≠t';
          document.getElementById('autoplayNotice').style.display = 'none';
          if(volSlider) volSlider.style.display = 'block';
        }).catch(()=>{
          // still blocked; ask user to click anywhere
          document.getElementById('autoplayNotice').style.display = 'block';
        });
      } else {
        bgAudio.pause();
        musicOn = false;
        musicBtn.textContent = 'üîà Nh·∫°c: T·∫Øt';
        if(volSlider) volSlider.style.display = 'none';
      }
    });

    // If user clicks anywhere, try to unmute/play (useful when autoplay blocked)
    document.body.addEventListener('click', function one(){
      ensureAudioCtx();
      if(!bgAudio) return;
      if(!musicOn){
        bgAudio.muted = false;
        if(volSlider) bgAudio.volume = volSlider.value/100;
        bgAudio.play().then(()=>{
          musicOn = true;
          musicBtn.textContent = 'üîä Nh·∫°c: B·∫≠t';
          document.getElementById('autoplayNotice').style.display = 'none';
          if(volSlider) volSlider.style.display = 'block';
        }).catch(()=>{
          document.getElementById('autoplayNotice').style.display = 'block';
        });
      }
      document.body.removeEventListener('click', one);
    }, {once:true});

    // Volume slider control
    if(volSlider){
      // slider is already initialized by loadSavedVolume()
      volSlider.addEventListener('input', (e)=>{
        const val = e.target.value;
        const v = val/100;
        bgAudio.volume = v;
        // Save volume when user changes it
        saveVolume(val);
        // if user raises volume, unmute
        if(bgAudio.muted && v>0){ bgAudio.muted = false; }
        saveAudioState();
      });
    }

    // On any user interaction, try to resume if state was saved
    function tryResumeOnInteraction(){
      if(musicOn && !bgAudio.paused) return; // already playing
      const state = restoreAudioState();
      if(state && state.wasPlaying){
        console.log('[audio] resuming on user interaction');
        tryResumeFromState(state);
      }
    }
    
    document.addEventListener('click', tryResumeOnInteraction, {once: false});
    document.addEventListener('touchstart', tryResumeOnInteraction, {once: false});

    /* ========== Play flip sound when pages change ========== */
    const originalNext = next;
    const originalPrev = prev;
    // wrap next/prev to include flip sound + subtle extra shadow pulse
    window.next = function(){
      originalNext();
      playFlipSound();
      saveAudioState();
    }
    window.prev = function(){
      originalPrev();
      playFlipSound();
      saveAudioState();
    }

    // Save audio state when page becomes hidden or closes
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){
        console.log('[audio] page hidden - saving state');
        saveAudioState();
        if(bgAudio) bgAudio.pause();
      } else {
        console.log('[audio] page visible - trying to resume');
        const state = restoreAudioState();
        if(state && state.wasPlaying){
          tryResumeFromState(state);
        }
      }
    });

    window.addEventListener('pagehide', ()=>{ 
      saveAudioState(); 
      if(bgAudio) bgAudio.pause(); 
    });
    window.addEventListener('beforeunload', ()=>{ saveAudioState(); });
    window.addEventListener('blur', ()=>{ 
      saveAudioState(); 
      if(bgAudio) bgAudio.pause(); 
    });

  </script>
</body>
</html>
